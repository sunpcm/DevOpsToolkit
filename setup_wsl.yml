---
- name: Setup Perfect WSL2 Dev Environment (v2.0)
  hosts: localhost
  connection: local
  gather_facts: true
  become: false # é»˜è®¤ä¸ç”¨ rootï¼ŒæŒ‰éœ€å¼€å¯

  vars:
    # å®šä¹‰è¦é€šè¿‡ Homebrew å®‰è£…çš„å·¥å…·
    brew_packages:
      - git
      - neovim        # ç°ä»£åŒ– Vim
      - bat           # å¸¦é¢œè‰²çš„ cat
      - fzf           # æ¨¡ç³Šæœç´¢ç¥å™¨
      - zoxide        # æ™ºèƒ½ cd å‘½ä»¤
      - tldr          # ç®€åŒ–çš„ man æ‰‹å†Œ
      - ripgrep       # è¶…å¿«çš„ grep
      - fd            # è¶…å¿«çš„ find
      - starship      # æé€Ÿ Shell æç¤ºç¬¦

    # å®šä¹‰ Homebrew çš„å®‰è£…è·¯å¾„ (Linux ä¸‹çš„æ ‡å‡†è·¯å¾„)
    brew_install_path: "/home/linuxbrew/.linuxbrew/bin"

  tasks:
    # -------------------------------------------------------
    # 1. åŸºç¡€ç³»ç»Ÿä¾èµ– (éœ€è¦ sudo å¯†ç )
    # -------------------------------------------------------
    - name: "ç³»ç»Ÿ: æ›´æ–° apt ç¼“å­˜"
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: "ç³»ç»Ÿ: å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…· (Homebrew ä¾èµ–)"
      become: true
      apt:
        name:
          - build-essential
          - curl
          - file
          - git
          - unzip
        state: present

    # -------------------------------------------------------
    # 2. å®‰è£… Homebrew
    # -------------------------------------------------------
    - name: "å·¥å…·: æ£€æŸ¥ Homebrew æ˜¯å¦å­˜åœ¨"
      stat:
        path: "{{ brew_install_path }}/brew"
      register: brew_check

    - name: "å·¥å…·: å®‰è£… Homebrew (å¦‚æœä¸å­˜åœ¨)"
      shell: |
        NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: not brew_check.stat.exists

    # -------------------------------------------------------
    # 3. å®‰è£… Zsh å’Œ Oh My Zsh
    # -------------------------------------------------------
    - name: "Shell: å®‰è£… Zsh"
      become: true
      apt:
        name: zsh
        state: present

    - name: "Shell: æ£€æŸ¥ Oh My Zsh"
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh"
      register: omz_check

    - name: "Shell: å®‰è£… Oh My Zsh"
      shell: sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
      when: not omz_check.stat.exists

    - name: "Shell: å®‰è£… Zsh æ’ä»¶"
      git:
        repo: "{{ item.repo }}"
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/custom/plugins/{{ item.name }}"
      loop:
        - { name: "zsh-autosuggestions", repo: "https://github.com/zsh-users/zsh-autosuggestions" }
        - { name: "zsh-syntax-highlighting", repo: "https://github.com/zsh-users/zsh-syntax-highlighting" }

    - name: "é…ç½®: æ›´æ”¹å½“å‰ç”¨æˆ·é»˜è®¤ Shell ä¸º Zsh"
      become: true
      user:
        name: "{{ ansible_env.USER }}"
        shell: /usr/bin/zsh

    # -------------------------------------------------------
    # 4. é€šè¿‡ Homebrew å®‰è£…ç°ä»£å¼€å‘å·¥å…·
    #    å…³é”®ä¿®æ­£: æ˜¾å¼æŒ‡å®š PATH ç¯å¢ƒå˜é‡ï¼Œé˜²æ­¢æ‰¾ä¸åˆ° brew
    # -------------------------------------------------------
    - name: "å·¥å…·: å®‰è£…ç°ä»£ CLI å·¥å…· (bat, fzf, zoxide...)"
      community.general.homebrew:
        name: "{{ item }}"
        state: present
        update_homebrew: yes
      loop: "{{ brew_packages }}"
      environment:
        PATH: "{{ brew_install_path }}:{{ ansible_env.PATH }}"

    # -------------------------------------------------------
    # 5. Node.js ç¯å¢ƒ (NVM)
    # -------------------------------------------------------
    - name: "Node: æ£€æŸ¥ NVM"
      stat:
        path: "{{ ansible_env.HOME }}/.nvm"
      register: nvm_check

    - name: "Node: å®‰è£… NVM"
      shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
      when: not nvm_check.stat.exists

    # -------------------------------------------------------
    # 6. ç”Ÿæˆæœ€ç»ˆçš„ .zshrc
    #    æ”¹è¿›: å¢åŠ äº† starship init å’Œ PATH ä¿®å¤
    # -------------------------------------------------------
    - name: "é…ç½®: æ³¨å…¥å®Œç¾ç‰ˆ .zshrc"
      blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
        create: yes
        block: |
          # --- Homebrew ---
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

          # --- Oh My Zsh ---
          export ZSH="$HOME/.oh-my-zsh"
          ZSH_THEME="agnoster"  # å¦‚æœç”¨äº† Starshipï¼Œè¿™ä¸ªä¸»é¢˜ä¼šè¢«è¦†ç›–ï¼Œæ²¡å…³ç³»
          plugins=(git zsh-autosuggestions zsh-syntax-highlighting extract)
          source $ZSH/oh-my-zsh.sh

          # --- ç°ä»£åŒ–å·¥å…·é…ç½® ---
          alias cat="bat"
          eval "$(zoxide init zsh)"
          # alias cd="z" # æ¯”è¾ƒæ¿€è¿›çš„åˆ«åï¼Œå¦‚æœä½ ä¸ä¹ æƒ¯å¯ä»¥æ³¨é‡Šæ‰è¿™ä¸€è¡Œï¼Œæ‰‹åŠ¨æ•² z
          
          # --- Starship (é¢œå€¼æ ¸å¿ƒ) ---
          eval "$(starship init zsh)"

          # --- ä»£ç†è®¾ç½® (è‡ªåŠ¨è·å– Windows IP) ---
          # ç«¯å£ 7890 è¯·æ ¹æ®ä½  Windows ä»£ç†è½¯ä»¶å®é™…ç«¯å£ä¿®æ”¹
          export HOST_IP=$(cat /etc/resolv.conf | grep nameserver | awk '{ print $2 }')
          function proxy_on() {
              export http_proxy="http://${HOST_IP}:7890"
              export https_proxy="http://${HOST_IP}:7890"
              export all_proxy="http://${HOST_IP}:7890"
              echo "ğŸš€ Proxy ON (IP: ${HOST_IP}:7890)"
          }
          function proxy_off() {
              unset http_proxy https_proxy all_proxy
              echo "ğŸ›‘ Proxy OFF"
          }

          # --- NVM ---
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

  post_tasks:
    - name: "å®Œæˆæç¤º"
      debug:
        msg:
          - "âœ… æ­å–œï¼å®Œç¾ WSL å¼€å‘ç¯å¢ƒé…ç½®å®Œæˆã€‚"
          - "ğŸ‘‰ è¯·ç«‹å³é‡å¯ç»ˆç«¯ (å…³é—­å†æ‰“å¼€) ä»¥åº”ç”¨ Shell æ›´æ”¹ã€‚"
          - "ğŸ’¡ æç¤º: è¾“å…¥ 'proxy_on' å¯å¼€å¯ä»£ç†åŠ é€Ÿã€‚"